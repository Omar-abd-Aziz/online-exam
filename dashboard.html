

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dashboard</title>

    <!-- css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
    <link rel="stylesheet" href="./css/framework.css" />
    <link rel="stylesheet" href="./css/master.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <!-- css -->

    <!-- fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;500&display=swap" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- fonts -->

    <!-- page icon -->
    <link rel="icon" type="image/x-icon" href="">
    <!-- page icon -->

    <!-- cdn moment js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="./js cdn/momentCdn.js"></script>
    <!-- cdn moment js -->


  </head>

  <body>

    <div class="page d-flex">
      

      <!-- main section -->
      <div class="content w-full">
        
        <!-- Start Head -->
        <div class="head bg-white between-flex" style="padding: 0px 10px 15px; background: #f1f5f9;">
          <div class="p-relative">
            <h1 class="p-relative PageOrdersCountDad" style="text-align: center;">
              الاختبارات
              <span class="PageOrdersCount">0</span>
            </h1>
          </div>
          <!-- <div class="icons d-flex align-center">
            <a href="./index.html" title="ذهاب للمتجر">
              <i class="fa-solid fa-store" style="color: black; font-size: 30px; margin: 18px 0px 0px;"></i>
            </a>
          </div> -->
        </div>
        <!-- End Head -->

        <div style="display: flex;align-items: center; justify-content: space-between; margin: 10px 5px; overflow: scroll;">
          <div>
            <select class="limitToFirst">
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="2000">2000</option>
              <option value="10000">10000</option>
            </select>
          </div>

          <div class="SearchDiv mainClassForSetColor" style="background: #0a1951; border-radius: 6px; border: none; padding: 5px;">
            <select dir="rtl" class="SearchField" style="margin: 5px 0px;font-size: 20px;background: white;color: black;padding: 5px;border: 2px solid black;border-radius: 6px;text-align: start;font-weight: bold;">
              <option value="id">كود الاختبار</option>
              <option value="examName">اسم الاختبار</option>
              <!-- <option value="dateStart"> تاريخ البداياء </option>
              <option value="time"> مدة الاختبار </option>
              <option value="dateEnd"> تاريخ النهاية </option> -->
            </select>
            <input type="text" dir="auto" placeholder="Search text" class="addOrderInput SearchInput" style="max-width: 150px; font-size: 20px;">
            <button class="SearchBtn" style="cursor: pointer; font-size: 20px;background: white;color: black;padding: 5px;border: 2px solid black;border-radius: 6px;text-align: end;font-weight: bold;">Search</button>
          </div>

          <button style="font-size: 18px; font-family:cairo; cursor:pointer; width: 120px; margin: 20px; border-radius: 10px; background: #0a1951; color: white; padding: 5px 0px; font-weight: 600; border: none; min-width: 120px;" class="addNewOrder mainClassForSetColor">اضافة اختبار</button>
        </div>

        <div style="overflow: auto;">

          <div class="table-wrapper">
            <table class="fl-table">
                <thead class="mainClassForSetColor">
                <tr>
                    <th>التعديل</th>
                    <th> مدة الاختبار </th>
                    <th>تاريخ نهاية الاختبار</th>
                    <th>تاريخ بداية الاختبار</th>
                    <th>اسم الاختبار</th>
                    <th>كود الاختبار</th>
                    <th>#</th>
                </tr>
                </thead>

                <tbody id="AllOrders">
                
                </tbody>
            </table>

            <!-- start load more div and btn -->
            <div style="display: flex;justify-content: center;padding: 10px 0px;">
              <button class="loadMoreBtn">Load More</button>
              <div class="loaderIcon" style="display: none;">
                <i style="font-size: 35px;padding: 5px; " class="fa-solid fa-spinner fa-spin"></i>
              </div>
            </div>
            <!-- end load more div and btn -->

        </div>
          
        </div>

      </div>
      <!-- main section -->

      <!-- Sidebar -->
      <div class="sidebar bg-white p-20 p-relative">
        <div class="HelloDiv">

          <div style="display: flex; justify-content: center;">

            <input style="display: none;" id="personImgInput" type="file" name="img" accept="image/*">
            <label for="personImgInput" style="cursor: pointer;">
              <img style="width: 100px;" class="personImg" src="https://img.freepik.com/free-icon/user_318-159711.jpg" alt="">
            </label>

          </div>

          <h2>Hello <span id="AdminName" style="color: #397eaf"></span></h2>
        </div>
        <ul>
          
          <li class="AllPagesBtns">
           

          </li>
          <a class="Orders-Accepted active d-flex align-center fs-14 c-black rad-6 p-10" style="display: flex; justify-content: end; cursor: pointer; background: rgba(137, 8, 8, 0.676); color: white;" id="logOut-digital">
            <span style="font-weight: bold; font-size:20px;">تسجيل الخروج</span>
            <i class="fas fa-sign-out-alt fa-fw" style="font-weight: bold; font-size:20px; margin-left: 10px; color: white;"></i>
          </a>
          
        </ul>
      </div>
      <!-- Sidebar -->

    </div>

  </body>
  
  <!-- swal -->
  <script src="./js cdn/swal.js"></script>
  <!-- swal -->

  <!-- firebase  -->
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-database.js"></script>
  <!-- firebase  -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.debug.js" integrity="sha512-234m/ySxaBP6BRdJ4g7jYG7uI9y2E74dvMua1JzkqM3LyWP43tosIqET873f3m6OQ/0N6TKyqXG4fLeHN9vKkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js" integrity="sha512-1g3IT1FdbHZKcBVZzlk4a4m5zLRuBjMFMxub1FeIRvR+rhfqHFld9VFXXBYe66ldBWf+syHHxoZEbZyunH6Idg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <!-- All dashboard Pages js file  -->
  <script src="./AllPagesObject.js"></script>
  <!-- All dashboard Pages js file  -->


<script type="module">

/* start import from firebase */

  import {docName, initializeApp,firebaseConfig ,getFirestore,getCountFromServer, collection, query, where, getDocs,getDoc, setDoc, updateDoc, addDoc, doc,deleteDoc,onSnapshot,orderBy, limit,startAt,endAt } from './firebase.js';

  firebase.initializeApp(firebaseConfig);
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const storage = firebase.storage();
  /**/

  let X;

  async function getCit(db,X) {
  const citiesCol = collection(db,`${X}`);
  const citySnapshot = await getDocs(citiesCol);
  const cityList = citySnapshot.docs.map(doc => doc.data());
  return cityList;
  };

/* end import from firebase */








/* start return AllStoreProducts */

let AllStoreProducts;

async function forAllExams(X){

  const q = query(collection(db, "exams"),where("AdminId","==",`${mainPersonData.id}`), orderBy("date","desc"), limit(X||10));
  const querySnapshot = await getDocs(q);
  const cityList = querySnapshot.docs.map(doc => doc.data());

  AllStoreProducts=cityList;

  return AllStoreProducts;
};

/* end return AllStoreProducts */


//////////////////////////////////////////////////////////////////////////










/*start login cods*/




/*  start check and get user doc */
let AllPersonsData;
let mainPersonData;
let docId = await localStorage.getItem(`${docName}`);

if(docId!==null&&docId.trim()!==''){
    // document.querySelector('.profile-btn').dataset.personid=docId;
    // mainPersonData=await getUserDataWithId(docId);
    mainPersonData= JSON.parse(localStorage.getItem(`${docName}_personData`));

    if(mainPersonData.isAdmin==false){
      location.href="./Dashboard-notAdmin.html";
    };

    document.querySelector("#AdminName").textContent=`${mainPersonData.username}`;
    document.querySelector(".personImg").src=mainPersonData.personImg||"https://img.freepik.com/free-icon/user_318-159711.jpg"


    const colRef= collection(db,"exams");

    getAllExams();
    /* start getOrdersCount */

    let q = query(collection(db, "exams"),where("AdminId","==",`${docId}`));
    let snapshot = await getCountFromServer(q);
    document.querySelector(".PageOrdersCount").textContent=`${snapshot.data().count}`;

    /* end getOrdersCount */


} else {
  location.href="./login/login.html"
}

/*  end check and get user doc */





/*  start get AllAccounts */

async function getUserDataWithId(id){
  let userData;
  await getDoc(doc(db, "accounts", `${id}`)).then(e=>{
    userData=e.data();
  });
  return userData;
}

/*  end get All Accounts */

/*end login cods*/










/* start img upload and show */

let personImgInput = document.querySelector("#personImgInput")
personImgInput.addEventListener("change",()=>{

  Swal.fire({
    title: 'Please Wait!',
    didOpen: () => {
      Swal.showLoading()
    }
  });



  let firebaseStorageUrl = document.querySelector('.personImg').src;
  let startIndex = firebaseStorageUrl.indexOf('o/') + 2;
  let endIndex = firebaseStorageUrl.indexOf('?alt=media');
  let filePathAndName = firebaseStorageUrl.substring(startIndex, endIndex);
  let fileName = decodeURIComponent(filePathAndName);


  let imageRef = storage.ref().child(fileName);
  // Delete the file
  imageRef.delete().then(function() {
    console.log("done")
  }).catch(function(error) {
    console.log("error")
  });


  let ref = firebase.storage().ref();
  let file = personImgInput.files[0];
  let name = +new Date() + "-" + file.name;
  let metadata = {
    contentType: file.type
  };

  let task = ref.child(name).put(file, metadata);
  task
  .then(async snapshot => snapshot.ref.getDownloadURL())
  .then(async url => {

    console.log(mainPersonData.id)

    updateDoc(doc(db, "accounts", `${mainPersonData.id}`), {
      personImg: url,
    }).then(e=>{
      Swal.fire("Done","","success")
      console.log(url);
      document.querySelector('.personImg').src=url;
      mainPersonData.personImg=url;
      localStorage.setItem(`${docName}_personData`,JSON.stringify(mainPersonData));
    })
    

  })
  .catch(console.error);


});


/* end img upload and show */









/* start limitToFirst btn */

document.querySelector(".limitToFirst").addEventListener("change",(e)=>{

let limitToFirst=e.srcElement.value;

getAllExams(limitToFirst);
  
});

/* end limitToFirst btn */










/*  start get AllStoreProducts */

async function getAllExams(X){
  
  forAllExams(X).then(ell=>{
    let i = 0;
  
    AllPersonsData=ell;
  
    if(ell.length!==0){
      document.querySelector("#AllOrders").innerHTML="";
    }

    showExams(ell);

  });

};


/*  End get AllStoreProducts */








/* start search in firebase doc (search in students) */


document.querySelector(".SearchBtn").addEventListener("click",async ()=>{

let SearchField = document.querySelector(".SearchField").value;
let SearchInput = document.querySelector(".SearchInput").value;

SearchField=SearchField.trim();
SearchInput=SearchInput.trim();

// console.log(SearchField,SearchInput);

if(SearchField!==""&&SearchField!=="SearchInput"){

  const q = query(collection(db, "exams"), where(SearchField, '==', SearchInput),where("AdminId","==",`${mainPersonData.id}`), orderBy("date","desc"),limit(5));

  const querySnapshot = await getDocs(q);
  const cityList = querySnapshot.docs.map(doc => doc.data());
  let AllFromSearch=cityList;

  // console.log(AllFromSearch);
  document.querySelector("#AllOrders").innerHTML=``;

  AllPersonsData=AllFromSearch;
  showExams(AllFromSearch);


  document.querySelector(".loadMoreBtn").dataset.search=`${JSON.stringify({
    SearchField: SearchField,
    SearchInput: SearchInput
  })}`;

  
};

});


/* end search in firebase doc (search in students) */






/* start show products function */

function showExams(array){
  let i = 0;

  array.forEach(el=>{
    i++;

    document.querySelector("#AllOrders").innerHTML+=`

    <tr data-id="${el.id}" style="font-weight: 600;">
      <td class="Order-Editing">
                      

        <a>
          <i title="حذف" class="fa-solid fa-trash removeOrder" data-id="${el.id}" style="font-size: 20px; color: white; background: darkred; border-radius: 50%; padding: 6px 8px; cursor: pointer;"></i>
        </a>

        <a>
          <i title="اخفاء/اظهار اجابات الطالب والاجابات الصحيحه للامتحان" class="fa-sharp fa-solid ${el.trueAnswersShowisHidden==true?`fa-eye-slash`:`fa-eye`} trueAnswersShow-Hidden" data-id="${el.id}" style="display: ${el.isHidden==true?`none`:`unset`}; font-size: 25px; color: green; background: white; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>


        <a>
          <i title="اخفاء/اظهار النتيجة" class="fa-sharp fa-solid ${el.isHidden==true?`fa-eye-slash`:`fa-eye`} Result-Hidden" data-id="${el.id}" style="font-size: 25px; color: #233245; background: white; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>

        <a>
          <i title="تعديل" class="fa-solid fa-pen-to-square editOrder" data-id="${el.id}" style="font-size: 20px; color: #e0dfdf; background: #233245; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>


        <a href="./index.html?exam=${el.id}" target="_blank">
          <i title=" لينك الاختبار  " class="fa-solid fa-paperclip" data-id="${el.id}" style="font-size: 22px; color: white; background: green; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>

        <a href="./index.html?editExam=${el.id}" target="_blank">
          <i title=" لينك تعديل الاختبار  " class="fa-solid fa-paperclip" data-id="${el.id}" style="font-size: 22px; color: white; background: var(--main-bg); border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>


        <a>
          <i title="نتايج الطلاب" class="fa-sharp fa-solid fa-circle-info examResults" data-id="${el.id}" style="font-size: 22px; color: white; background: black; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
        </a>

                      
      </td>
      
      <td class="Exam-Time">${el.examTime}</td>
      <td class="Exam-DateEnd">${returnDateAndTime(el.dateEnd)}</td>
      <td class="Exam-DateStart">${returnDateAndTime(el.dateStart)}</td>
      <td class="Exam-Name">
        <bdi class="Product-Name">
          ${el.examName}
        </bdi>
      </td>
      <td class="Exam-Id">${el.id}</td>
      <td class="Exam-Id">#${i}</td>
    </tr>
    
    `;
  });
};

/* end show products function */








/*//////////////////////////////////////////////////////////////////*/

window.onclick=async(e)=>{

/* start Result-Hidden btn */ 

if([...e.target.classList].includes("Result-Hidden")){


  let icon = e.target;

  let examId=e.target.dataset.id;
  let examData=AllPersonsData.find(el=>el.id==`${examId}`);

  // console.log(productData)
  let title = `هل تريد ${examData.isHidden==true?"اظهار":"اخفاء"} نتيجة هذا الاختبار للطلاب عند انهائهم للاختبار ؟`;

  Swal.fire({
  title: `${title}`,
  text: "",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonColor: '#3085d6',
  cancelButtonColor: '#d33',
  confirmButtonText: 'Yes'
  }).then((result) => {
    if (result.isConfirmed) {

      Swal.fire({
        title: 'Please Wait!',
        didOpen: () => {
          Swal.showLoading()
        }
      });

      let x = (examData.isHidden==true?false:true);

      updateDoc(doc(db,"exams",examId),{
        isHidden: x,
      }).then(e=>{

        examData.isHidden=x;

        let trueAnswersShowBtn = [...document.querySelectorAll(`[data-id="${examId}"]`)].find(el=>[...el.classList].includes("trueAnswersShow-Hidden")==true)

        console.log(trueAnswersShowBtn);

        if(x){

          // the result will appear to the students on the end of exam
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");

          // trueAnswersShowBtn will hidden
          trueAnswersShowBtn.style.display="none";

        }else{

          // the result would not appear to the students on the end of exam
          icon.classList.add("fa-eye");
          icon.classList.remove("fa-eye-slash");

          // trueAnswersShowBtn will show
          trueAnswersShowBtn.style.display="unset";
          
        }



  

        Swal.fire(
          'Done!',
          '',
          'success'
        );

      });


    }
  })


};

/* end Result-Hidden btn*/





/* start trueAnswersShow-Hidden btn */ 

if([...e.target.classList].includes("trueAnswersShow-Hidden")){


let icon = e.target;

let examId=e.target.dataset.id;
let examData=AllPersonsData.find(el=>el.id==`${examId}`);

// console.log(productData)
let title = `هل تريد ${examData.trueAnswersShowisHidden==true?"اظهار":"اخفاء"} اجابات الطالب والاجابات الصحيحة للامتحان عندما يقوم الطالب بانهاء الامتحان ؟`;

Swal.fire({
title: `${title}`,
text: "",
icon: 'warning',
showCancelButton: true,
confirmButtonColor: '#3085d6',
cancelButtonColor: '#d33',
confirmButtonText: 'Yes'
}).then((result) => {
  if (result.isConfirmed) {

    Swal.fire({
      title: 'Please Wait!',
      didOpen: () => {
        Swal.showLoading()
      }
    });

    let x = (examData.trueAnswersShowisHidden==true?false:true);

    updateDoc(doc(db,"exams",examId),{
      trueAnswersShowisHidden: x,
    }).then(e=>{

      examData.trueAnswersShowisHidden=x;

      let trueAnswersShowBtn = [...document.querySelectorAll(`[data-id="${examId}"]`)].find(el=>[...el.classList].includes("trueAnswersShow-Hidden")==true)

      console.log(trueAnswersShowBtn);

      if(x){

        // the true Answers for  will appear to the students on the end of exam
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");

      }else{

        // the result would not appear to the students on the end of exam
        icon.classList.add("fa-eye");
        icon.classList.remove("fa-eye-slash");

      }


      Swal.fire(
        'Done!',
        '',
        'success'
      );

    });


  }
})


};

/* end trueAnswersShow-Hidden btn*/




if([...e.target.classList].includes("printPage")){

  e.target.style.display="none";
  window.print();
  Swal.fire("Done","","success")


}


if([...e.target.classList].includes("downloadAllResultsPdf")){

  let examId = e.target.dataset.id;

  let q = query(collection(db,"exams",`${examId}`,`results`));
  let querySnapshot = await getDocs(q);
  let cityList = querySnapshot.docs.map(doc => doc.data());
  console.log(cityList);

  let div = document.createElement("tbody");

  

  cityList.forEach(el=>{
    div.innerHTML+=`
      <tr>
        <td style="text-align: center; border: 1px solid #dddddd; padding: 8px;">${el.userName}</td>
        <td style="text-align: center; border: 1px solid #dddddd; padding: 8px;">${el.phoneNumber}</td>
        <td style="text-align: center; border: 1px solid #dddddd; padding: 8px;">${el.result}</td>
        <td style="text-align: center; border: 1px solid #dddddd; padding: 8px;">
          <a href="${window.location.origin}?exam=${examId}&studentAnswerId=${el.id}" target="_blank">
            <button style="font-size: 18px; font-family:cairo; cursor:pointer; width: 120px; margin: 20px; border-radius: 10px; background: black; color: white; padding: 5px 0px; font-weight: 600; border: none; min-width: 120px;">اجابات الطالب</button>  
          </a>
        </td>
        <td style="text-align: center; border: 1px solid #dddddd; padding: 8px;">
          <i title="حذف" class="fa-solid fa-trash removeStudentResult" data-exam-id="${examId}" data-id="${el.id}" style="font-size: 20px; color: white; background: darkred; border-radius: 50%; padding: 6px 8px; cursor: pointer;"></i>
        </td>
      </tr>
    `;
  })

  console.log(div)

  Swal.fire({
    html:`
      <table style="  font-family: arial, sans-serif;border-collapse: collapse;width: 100%; margin: 15px 10px;">
        <tbody>
          <tr>
            <td style="text-align: center; background: var(--main-bg);color: white; border: 1px solid #dddddd; padding: 8px;">Name</td>
            <td style="text-align: center; background: var(--main-bg);color: white; border: 1px solid #dddddd; padding: 8px;">PhoneNumber</td>
            <td style="text-align: center; background: var(--main-bg);color: white; border: 1px solid #dddddd; padding: 8px;">Result</td>
            <td style="text-align: center; background: var(--main-bg);color: white; border: 1px solid #dddddd; padding: 8px;">اجابات الطالب</td>
            <td style="text-align: center; background: var(--main-bg);color: white; border: 1px solid #dddddd; padding: 8px;">edit</td>
          </tr>
          ${div.innerHTML}
        </tbody>
      </table>
      <br>
      <button class="printPage">Print</button>
    `,
    width: "100%",
    showConfirmButton: false,
    showCloseButton: true
  });

  // var doc = new jsPDF();
  // var text = JSON.stringify(cityList, null, 4);

  // doc.setFontSize(10);
  // doc.text(20, 20, text);

  // doc.save("json_data.pdf");

}

if([...e.target.classList].includes("examResults")){

  Swal.fire({
    title: 'Please Wait!',
    didOpen: () => {
      Swal.showLoading()
    }
  });

  let examId = e.target.dataset.id;
  console.log(examId)

  let q = query(collection(db,"exams",`${examId}`,`results`));
  let snapshot = await getCountFromServer(q);

  Swal.fire({
      title: '',
      html:`

      <bdi style="margin: 5px;font-size: 24px;font-family: cairo;font-weight: bold;">
      نتايج الطلاب: ${snapshot.data().count} نتيجة
      <i class="fa-solid fa-file-pdf downloadAllResultsPdf" data-id="${examId}" style="color: darkred; cursor: pointer; margin: 5px 10px;"></i>
      <a href="${location.origin+"/index.html?examResult="+examId}">
        <i class="fa-solid fa-link AllResultsLinkForStudents" title="لينك الاستعلام عن النتيجة للطلاب" data-id="${examId}" style="color: black; cursor: pointer; margin: 5px 10px;"></i>
      </a>
      </bdi>

      

      <hr>

      <bdi style="margin: 5px;font-size: 24px;font-family: cairo;font-weight: bold;">
      بحث في النتائج:
      </bdi>

      <div class="" style=" border-radius: 6px; border: none; padding: 5px;">
        <select dir="rtl" class="SearchFiledForResult" style="margin: 5px 0px;font-size: 20px;background: white;color: black;padding: 5px;border: 2px solid black;border-radius: 6px;text-align: start;font-weight: bold;">
          <!--<option value="userName">اسم الطالب</option>-->
          <option value="phoneNumber"> رقم هاتف الطالب </option>
        </select>
        <input type="text" dir="auto" placeholder="Search text" class="addOrderInput SearchValueForResult" style="max-width: 150px; font-size: 20px;">
      </div>

      `,
      confirmButtonText:
      `<b>Search <i class="fa-solid fa-magnifying-glass"></i></b>`,
  }).then(async el=>{
    if(el.isConfirmed){
      let SearchFiledForResult = document.querySelector(".SearchFiledForResult").value.trim();
      let SearchValueForResult = document.querySelector(".SearchValueForResult").value.trim();


      if(SearchFiledForResult!==""&&SearchValueForResult!==""){
        let q = query(collection(db,"exams",`${examId}`,`results`),where(`${SearchFiledForResult}`,"==",`${SearchValueForResult}`));
        let querySnapshot = await getDocs(q);
        let cityList = querySnapshot.docs.map(doc => doc.data());

        if(cityList.length<1){
          Swal.fire("لا يوجد بيانات لهذا الرقم","","error")
        } else{
          Swal.fire({
            title: `${cityList[0].userName+"<br>"+cityList[0].result}`,
            icon: 'success',
            showCloseButton: true,
            showConfirmButton: false,
            showCancelButton: false,
            html: `
            
            <a href="${window.location.origin}?exam=${examId}&studentAnswerId=${cityList[0].id}">
              <button style="font-size: 18px; font-family:cairo; cursor:pointer; width: 120px; margin: 20px; border-radius: 10px; background: black; color: white; padding: 5px 0px; font-weight: 600; border: none; min-width: 120px;">اجابات الطالب</button>  
            </a>
            
            `,
          });

        }


      }


    }
  })
}






/* start loadMoreBtn btn*/

if([...e.target.classList].includes("loadMoreBtn")){

  e.target.style.display="none";
  document.querySelector(".loaderIcon").style.display="block";


  let lastElementDate=AllPersonsData[AllPersonsData.length-1].date;
  let q;

  if(e.target.dataset.search!==undefined){

    let search = JSON.parse(e.target.dataset.search);
    q = query(collection(db, "exams"),where("AdminId","==",`${mainPersonData.id}`),where(search.SearchField,"==",search.SearchInput),where("date","<",lastElementDate), orderBy("date","desc"), limit(X||5));
  
  } else{

    q = query(collection(db, "exams"),where("AdminId","==",`${mainPersonData.id}`),where("date","<",lastElementDate), orderBy("date","desc"), limit(X||5));
  
  }

  let querySnapshot = await getDocs(q);
  let cityList = querySnapshot.docs.map(doc => doc.data());
  let AllExamsFromLoadMore=cityList;

  AllPersonsData=[...AllPersonsData,...AllExamsFromLoadMore];

  document.querySelector("#AllOrders").innerHTML=``;
  await showExams(AllPersonsData);
  
  e.target.style.display="block";
  document.querySelector(".loaderIcon").style.display="none";
};



/* end loadMoreBtn btn*/










  









/* start order detals btn*/
if([...e.target.classList].includes("Order-Note")){

  let productId=e.target.dataset.id;
  let productData=AllPersonsData.find(el=>el.id==`${productId}`);
  console.log(productData)

    Swal.fire({
      title: `${productData.ProductName}`,
      html: `<textarea readonly dir="auto" style="min-height: 150px; cursor: auto; width: 100%;padding: 10px;font-size: 25px; font-weight: bold; border-radius:2px; border: 2px solid #00000096;">${e.target.dataset.note}</textarea>`,
      imageUrl: `${e.target.dataset.img}`,
      imageWidth: 400,
      imageHeight: 400,
      imageAlt: 'Custom image',
    })


}
/* end order detals btn*/





/* start remove product */
if([...e.target.classList].includes("removeOrder")){


  Swal.fire({
  title: 'Are you want to delet it?',
  text: "You won't be able to revert this!",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonColor: '#3085d6',
  cancelButtonColor: '#d33',
  confirmButtonText: 'Yes, delete it!'
  }).then((result) => {
    if (result.isConfirmed) {

      let productId=e.target.dataset.id;
      let productData=AllPersonsData.find(el=>el.id==`${productId}`);

      let productDoc=doc(db, "exams", productId);

      deleteDoc(productDoc); 

      AllPersonsData=AllPersonsData.filter(el=>el.id!==`${productId}`);
      document.querySelector("#AllOrders").innerHTML=``;
      showExams(AllPersonsData);
      Swal.fire(
        'Deleted!',
        'Product has been deleted.',
        'success'
      );

    }
  })


};

/* end remove product */




/* start remove student result */
if([...e.target.classList].includes("removeStudentResult")){


  let studentResultId=e.target.dataset.id;
  let examId=e.target.dataset.examId;

  let studentResultDoc=doc(db,"exams",`${examId}`,`results`,`${studentResultId}`);

  deleteDoc(studentResultDoc); 

  e.target.parentNode.parentNode.remove()


  // Swal.fire({
  // title: 'Are you want to delet it?',
  // text: "You won't be able to revert this!",
  // icon: 'warning',
  // showCancelButton: true,
  // confirmButtonColor: '#3085d6',
  // cancelButtonColor: '#d33',
  // confirmButtonText: 'Yes, delete it!'
  // }).then((result) => {
  //   if (result.isConfirmed) {

  //     let studentResultId=e.target.dataset.id;
  //     let examId=e.target.dataset.examId;

  //     let studentResultDoc=doc(db,"exams",`${examId}`,`results`,`${studentResultId}`);

  //     deleteDoc(studentResultDoc); 

  //     Swal.fire(
  //       'Deleted!',
  //       'Product has been deleted.',
  //       'success'
  //     );



  //   }
  // })


};

/* end remove student result */







/* start edit product */

if([...e.target.classList].includes("editOrder")){

  let examId=e.target.dataset.id;
  let examData=AllPersonsData.find(el=>el.id==`${examId}`);

  editExam(examData);

};



async function editExam(examData){

  console.log(examData);

  Swal.fire({
      title: 'قم بتعديل البيانات التالية',
      html: `
      
      <div class="mainForm" style="overflow-y: hidden; overflow-c: scroll; font-size: 17px!important; font-family: 'Cairo', sans-serif; font-weight: bold!important;">

        <label for="examName">اسم الاختبار</label>
        <input style="width: 98%;" class="addOrderInput" type="text" dir="auto" autocomplete="off" id="examName" value="${examData.examName}">
        
        <label for="dateStart">
          تاريخ بداية الاختبار
        </label>
        <input type="hidden" id="timezone" name="timezone" value="-08:00">
        <input type="datetime-local" style="width: 98%;" class="addOrderInput" id="dateStart" name="dateStart" min="2023-06-07T00:00" value="${examData.dateStart}">
        
        <label for="dateEnd">
          تاريخ نهاية الاختبار
        </label>
        <input type="hidden" id="timezone" name="timezone" value="-08:00">
        <input type="datetime-local" style="width: 98%;" class="addOrderInput" id="dateEnd" name="dateEnd" min="2023-06-07T00:00" value="${examData.dateEnd}">

        <label for="examTime">
            (بالساعات) مدة الاختبار
        </label>
        <input style="width: 98%;" class="addOrderInput" type="number" dir="auto" autocomplete="off" id="examTime" value="${examData.examTime}">

        </div>

      `,
      confirmButtonText: 'حفظ',
  }).then((result) => {    
      if (result.isConfirmed) {

            let examName=document.querySelector("#examName").value;
            let dateStart=document.querySelector("#dateStart").value;
            let dateEnd=document.querySelector("#dateEnd").value;
            let examTime = document.querySelector("#examTime").value;

            let id = examData.id;

            if(examName.trim()!==''&&dateStart.trim()!==''&&dateEnd.trim()!==''&&examTime.trim()!==''){


                updateDoc(doc(db,"exams",id), {
                  examName: examName,
                  dateStart: dateStart,
                  dateEnd: dateEnd,
                  examTime: examTime,
                }).then(e=>{

                  let mainEditedDiv = document.querySelector(`[data-id="${id}"]`)
                  mainEditedDiv.querySelector(".Exam-Name").textContent=examName;
                  mainEditedDiv.querySelector(".Exam-DateStart").textContent=returnDateAndTime(dateStart);
                  mainEditedDiv.querySelector(".Exam-DateEnd").textContent=returnDateAndTime(dateEnd);
                  mainEditedDiv.querySelector(".Exam-Time").textContent=examTime;

                  
                  let mainOrderFromAll = AllPersonsData.find(el=>el.id==`${id}`);
                  mainOrderFromAll.examName=examName;
                  mainOrderFromAll.dateStart=dateStart;
                  mainOrderFromAll.dateEnd=dateEnd;
                  mainOrderFromAll.examTime=examTime;

                  // console.log(AllPersonsData)
             

                  Swal.fire(
                    'تم التعديل',
                    '',
                    'success'
                  );

                });


            };
      };
  });

};

/* end edit product */










/* start btn to upload img  */

if([...e.target.classList].includes("ProductImgLabel")){

  let imgInput = e.target.parentNode.querySelector("#ProductImgInput");
  let img = e.target.parentNode.querySelector(".ProductImgUpload");

  if(imgInput==null){
    imgInput=e.target.parentNode.querySelector("#BannerImgInput");

    imgInput.addEventListener("change",(e)=>{

      let x = imgInput.files[0];
      const reader = new FileReader();
      reader.readAsDataURL(imgInput.files[0]);
      reader.onload = () => {
        document.querySelector(".ProductImgUpload").style.display="block"
        document.querySelector(".ProductImgUpload").src=reader.result
      };

    })

  } else if(imgInput!==null)
  {
    
  imgInput.addEventListener("change",(e)=>{

    document.querySelector(".ProductImgsUploadDad").innerHTML=``;
    for(let i=0; i<e.target.files.length; i++){
      let x = e.target.files[i];
      const reader = new FileReader();
      reader.readAsDataURL(e.target.files[i]);
      reader.onload = () => {
        document.querySelector(".ProductImgsUploadDad").innerHTML+=`
        
          <img src="${reader.result}" style="border-radius: 10px; margin: 10px auto; max-height: 200px; border-bottom: 3px solid black; margin-bottom: 10px;" class="ProductImgUpload">

        `;
      };
    };

    // e.target.value=null;
    document.querySelector(".ProductImgLabel").style.display="none";
    document.querySelector(".ProductImgsUploadDad").style.display="block";
    });
    
  }

};

/* end btn to upload img  */



};








/*  start add new Product */

document.querySelector(".addNewOrder").addEventListener("click",async ()=>{


  Swal.fire({
      title: ' اضافة اختبار جديد ',
      html: `
      
      <div class="mainForm" style="overflow-y: hidden; overflow-c: scroll; font-size: 17px!important; font-family: 'Cairo', sans-serif; font-weight: bold!important;">

        <label for="examName">اسم الاختبار</label>
        <input style="width: 98%;" class="addOrderInput" type="text" dir="auto" autocomplete="off" id="examName" >
        
        <label for="dateStart">
          تاريخ بداية الاختبار
        </label>
        <input type="hidden" id="timezone" name="timezone" value="-08:00">
        <input type="datetime-local" style="width: 98%;" class="addOrderInput" id="dateStart" name="dateStart" min="2023-06-07T00:00">
        
        <label for="dateEnd">
          تاريخ نهاية الاختبار
        </label>
        <input type="hidden" id="timezone" name="timezone" value="-08:00">
        <input type="datetime-local" style="width: 98%;" class="addOrderInput" id="dateEnd" name="dateEnd" min="2023-06-07T00:00">

        <label for="examTime">
            (بالساعات) مدة الاختبار
        </label>
        <input style="width: 98%;" class="addOrderInput" type="number" dir="auto" autocomplete="off" id="examTime" >

        </div>

      `,
      confirmButtonText: 'اضافة',
      showCancelButton: true,
  }).then(async (result) => {    
      if (result.isConfirmed) {
          let examName=document.querySelector("#examName").value;
          let dateStart=document.querySelector("#dateStart").value;
          let dateEnd=document.querySelector("#dateEnd").value;
          let examTime = document.querySelector("#examTime").value;

          function idGenerator() {
            return (Math.random()*10000000).toFixed();
          };

          let id = idGenerator();

          if(examName.trim()!==''&&dateStart.trim()!==''&&dateEnd.trim()!==''&&examTime.trim()!==''){
            Swal.fire({
              title: 'Please Wait!',
              didOpen: () => {
                Swal.showLoading()
              }
            });
            AddNewExam(examName,dateStart,dateEnd,examTime,id);
          };

      };
  });

});


/* end add new Product */




/* start function to AddNewProduct */

async function AddNewExam(examName,dateStart,dateEnd,examTime,id){

  let examDate = showDate();
  let date = Date.now();

  console.log(mainPersonData.username)
  console.log(mainPersonData.id)

  setDoc(doc(db,"exams",id), {
      id: id,
      examName: examName,
      dateStart: dateStart,
      dateEnd: dateEnd,
      examTime: examTime,
      examDate: examDate,
      date: date,
      theExam: [],
      AdminName: mainPersonData.username,
      AdminId: `${mainPersonData.id}`,
    }).then(async e=>{

      AllPersonsData=[{
        id: id,
        examName: examName,
        dateStart: dateStart,
        dateEnd: dateEnd,
        examTime: examTime,
        examDate: examDate,
        date: date,
        theExam: [],
        AdminName: mainPersonData.username,
        AdminId:`${mainPersonData.id}`,
      },...AllPersonsData];

      document.querySelector("#AllOrders").innerHTML=``;
      await showExams(AllPersonsData);

      Swal.fire("Done","","success")
      console.log(AllPersonsData)

    });

};


/* end function to AddNewProduct */



function returnDateAndTime(date){
  let timestamp = date;
  date = new Date(timestamp);

  let year = date.getFullYear();
  let month = String(date.getMonth() + 1).padStart(2, '0');
  let day = String(date.getDate()).padStart(2, '0');
  let hour = String(date.getHours() % 12 || 12);
  let minute = String(date.getMinutes()).padStart(2, '0');
  let meridiem = date.getHours() >= 12 ? 'pm' : 'am';

  let formattedDate = `${year}-${month}-${day} , ${hour}:${minute} ${meridiem}`;
  return formattedDate
}


/*  start function to editProduct */

function editProduct(ProductName,ProductPrice,ProductNote,ProductNote2,id,ProductImage,ProductCategorieId,ProductCategorieName,ArrayOfProductImages,ProductDate,date,ProductPriceBeforeRival){
  setDoc(doc(db,"StoreProducts",id), {
      id: id,
      ProductName: ProductName,
      ProductPriceBeforeRival: ProductPriceBeforeRival||"",
      ProductPrice: ProductPrice,
      ProductNote: ProductNote,
      ProductNote2: ProductNote2,
      ProductCategorieId: ProductCategorieId,
      ProductCategorieName: `${ProductCategorieName}`,
      ProductImage: ProductImage,
      ProductDate: ProductDate||showDate(),
      date: date||Date.now(),
      ArrayOfProductImages: ArrayOfProductImages,
      isHidden: false,
    }).then(e=>{});

};


/* end function to editProduct */










/*  start function to upload img when add new order */


async function uploadImageForAddNewProduct(input,ProductName,ProductPrice,ProductNote,id,ProductImage,ProductCategorieId,ProductCategorieName) {

let ArrayOfProductImagesOld = [];

if(input!=="noNewImg"){

  let ArrayOfProductImages = ArrayOfProductImagesOld||[];
  for(let i=0; i<input.files.length; i++){

    const ref = firebase.storage().ref();
    const file =  input.files[i];
    const name = +new Date() + "-" + file.name;
    const metadata = {
      contentType: file.type,
    };
    
    const task = ref.child(name).put(file, metadata);
    await task
    .then(async snapshot => snapshot.ref.getDownloadURL())
    .then(async url => {
    
      ArrayOfProductImages.push({src: url});
      
    })
    .catch(console.error);
    
    };

    Swal.fire("Done","","success");
    AddNewProduct(ProductName,ProductPrice,ProductNote,id, ArrayOfProductImages[0].src,ProductCategorieId,ProductCategorieName,ArrayOfProductImages);
  };


};


/* end function to upload img when add new order  */















/*  start function to upload img */


async function uploadImageForEditProduct(input,ProductName,ProductPrice,ProductNote,ProductNote2,id,ProductImage,ProductCategorieId,ProductCategorieName,ProductDate,date,ArrayOfProductImagesOld,ProductPriceBeforeRival) {

console.log(ArrayOfProductImagesOld);

if(input!=="noNewImg"){

  let ArrayOfProductImages = ArrayOfProductImagesOld||[];
  for(let i=0; i<input.files.length; i++){

    const ref = firebase.storage().ref();
    const file =  input.files[i];
    const name = +new Date() + "-" + file.name;
    const metadata = {
      contentType: file.type,
    };
    
    const task = ref.child(name).put(file, metadata);
    await task
    .then(async snapshot => snapshot.ref.getDownloadURL())
    .then(async url => {
    
      ArrayOfProductImages.push({src: url});
      
    })
    .catch(console.error);
    
    };

    Swal.fire("Done","","success");
    editProduct(ProductName,ProductPrice,ProductNote,ProductNote2,id, ArrayOfProductImages[0].src,ProductCategorieId,ProductCategorieName,ArrayOfProductImages,ProductDate,date,ProductPriceBeforeRival);
  };


};


/* end function to upload img */








/* 1 start function to get data now */
function showDate(){
  
  const d = new Date();
  
  let year = d.getFullYear();
  let month = d.getMonth();
  let day = d.getDate();
  let hour = d.getHours();
  let mint = d.getMinutes();
  
  if(mint<10){
    mint=`0${mint}`
  }
  
  let dateNow;

  // console.log(hour)

  if (hour>=12){
    
    dateNow= `
      ${year}/${month+1}/${day}
      => ${hour-12}:${mint} PM
      `;

  } else if (hour<=11){
    
      dateNow = `
      
      ${year}/${month+1}/${day}
         ${hour}:${mint} AM
      
      `;
  }
  return dateNow;
}

/* 1 end function to get data now */



























/* 2 start function to get differnce between data now */
function getDiffDate(oldDate){
        
    var starts = moment(`${oldDate}`);
    var ends   = moment();

    var duration = moment.duration(ends.diff(starts));

    // with ###moment precise date range plugin###
    // it will tell you the difference in human terms

    var diff = moment.preciseDiff(starts, ends, true); 
    // example: { "years": 2, "months": 7, "days": 0, "hours": 6, "minutes": 29, "seconds": 17, "firstDateWasLater":  false }


    // or as string:
    var diffHuman = moment.preciseDiff(starts, ends);
    // example: 2 years 7 months 6 hours 29 minutes 17 seconds

    let diffDate=diff;

    if(diffDate.years!==0){
        diffDate={
            "diffDateNum": diffDate.years,
            "diffDateName": "سنة",
        };
    } else if(diff.months!==0){
        diffDate={
            "diffDateNum": diffDate.months,
            "diffDateName": "شهر",
        };
    } else if(diff.days!==0){
        diffDate={
            "diffDateNum": diffDate.days,
            "diffDateName": "يوم",
        };
    } else if(diff.hours!==0){
        diffDate={
            "diffDateNum": diffDate.hours,
            "diffDateName": "ساعة",
        };
    } else if(diff.minutes!==0){
        diffDate={
            "diffDateNum": diffDate.minutes,
            "diffDateName": "دقيقة",
        };
    } else {
        diffDate={
            "diffDateNum": 0,
            "diffDateName": "الان",
        };
    }

    let stringDiffDate = `منذ ${diffDate.diffDateNum + " " + diffDate.diffDateName}`;
    // منذ 1 سنة

    if(diffDate.diffDateName=="الان"){
      stringDiffDate="الان";
    }
    
    // diffDate => json like {diffDateNum: 1, diffDateName: 'سنة'}

    return stringDiffDate;
}

// console.log(getDiffDate("2022/1/1 => 5:55 PM"));

/* 2 end function to get differnce between data now */



</script>


</html>
